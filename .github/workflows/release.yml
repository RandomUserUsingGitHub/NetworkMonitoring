name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write   # needed to create releases and upload assets

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: |
          xcode-select -p
          xcodebuild -version
          swift --version

      - name: List schemes (debug)
        run: |
          xcodebuild -project NetworkMonitor.xcodeproj -list

      - name: Build Release
        run: |
          xcodebuild \
            -project NetworkMonitor.xcodeproj \
            -scheme NetworkMonitor \
            -configuration Release \
            -derivedDataPath "$GITHUB_WORKSPACE/.build" \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            build

      - name: Verify binary
        run: |
          APP="$GITHUB_WORKSPACE/.build/Build/Products/Release/NetworkMonitor.app"
          ls -la "$APP/Contents/MacOS/"
          echo "App size: $(du -sh "$APP" | cut -f1)"

      - name: Sign ad-hoc
        run: |
          APP="$GITHUB_WORKSPACE/.build/Build/Products/Release/NetworkMonitor.app"
          codesign --force --deep --sign "-" "$APP"

      - name: Package
        run: |
          APP="$GITHUB_WORKSPACE/.build/Build/Products/Release/NetworkMonitor.app"
          mkdir -p dist/daemon
          cp -R "$APP"                  dist/
          cp daemon/network_monitor.sh  dist/daemon/
          cp daemon/netmon-toggle.sh    dist/daemon/
          cp install.sh                 dist/
          cp README.md                  dist/
          chmod +x dist/install.sh dist/daemon/*.sh
          zip -r NetworkMonitor-release.zip dist/ -x "*.DS_Store" -x "__MACOSX/*"
          echo "Zip size: $(du -sh NetworkMonitor-release.zip | cut -f1)"
          unzip -l NetworkMonitor-release.zip

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          name: "Network Monitor ${{ github.ref_name }}"
          body: |
            ## ðŸŒ Network Monitor ${{ github.ref_name }}

            ### How to install
            1. Download **NetworkMonitor-release.zip** below â†“
            2. Unzip it
            3. Drag `NetworkMonitor.app` â†’ `/Applications`
            4. Open Terminal and run:
            ```
            bash install.sh
            ```
            > If macOS says "unidentified developer": right-click â†’ **Open** â†’ **Open Anyway** (once only)

            ### Requirements
            macOS 13 or later
          files: NetworkMonitor-release.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
